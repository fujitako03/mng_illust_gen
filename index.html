<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎨 イラスト生成アプリ (HTML版)</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .api-key-section {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .api-key-section h3 {
            margin-top: 0;
            color: #856404;
        }
        .api-key-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 10px;
        }
        .api-key-note {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 0;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .upload-area:hover {
            border-color: #007bff;
        }
        .upload-area.dragover {
            border-color: #007bff;
            background-color: #f0f8ff;
        }
        #fileInput {
            display: none;
        }
        .btn {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .results {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: none;
        }
        .output-section {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .features-output {
            background-color: #f7fafc;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e2e8f0;
            margin: 10px 0;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .alert-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .alert-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .alert-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .preview-image {
            max-width: 300px;
            max-height: 300px;
            margin: 20px auto;
            display: block;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .generated-image {
            text-align: center;
            margin: 20px 0;
        }
        .generated-image img {
            max-width: 100%;
            max-height: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* ステップ表示のスタイル */
        .steps-container {
            margin: 30px 0;
        }
        .step {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }
        .step.active {
            border-color: #007bff;
            background-color: #e7f3ff;
        }
        .step.completed {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .step-number {
            background-color: #6c757d;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }
        .step.active .step-number {
            background-color: #007bff;
        }
        .step.completed .step-number {
            background-color: #28a745;
        }
        .step-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        .step-description {
            color: #6c757d;
            margin: 10px 0;
            font-size: 14px;
        }
        .step-content {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎨 イラスト生成アプリ (HTML版)</h1>
        <p style="text-align: center; color: #6c757d; margin-bottom: 30px;">
            人物画像から7つの特徴を抽出し、「みん銀スタイル」の統一されたイラストを生成します
        </p>
        
        <!-- API Key設定セクション -->
        <div class="api-key-section">
            <h3>🔑 OpenAI API Key設定</h3>
            <input 
                type="password" 
                id="apiKeyInput" 
                class="api-key-input" 
                placeholder="sk-..."
                autocomplete="off"
            >
            
            <div style="margin-top: 15px;">
                <label for="qualitySelect" style="display: block; margin-bottom: 5px; font-weight: bold;">画質設定:</label>
                <select id="qualitySelect" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="low">Low (低画質・高速)</option>
                    <option value="mid">Mid (中画質)</option>
                    <option value="high" selected>High (高画質・推奨)</option>
                </select>
            </div>
            
            <p class="api-key-note">
                ⚠️ API Keyは一時的にブラウザのメモリにのみ保存されます。ページを更新すると削除されます。<br>
                API Keyは外部に送信されず、OpenAI APIとの通信にのみ使用されます。
            </p>
        </div>

        <!-- ステップ表示エリア -->
        <div class="steps-container">
            <!-- Step 1: 画像アップロード・解析 -->
            <div class="step" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div>
                        <h3 class="step-title">📸 人物の特徴を抽出</h3>
                        <p class="step-description">
                            人物画像をアップロードすると、自動で7つの特徴を抽出してイラストを生成します（API Key入力必須）
                        </p>
                    </div>
                </div>
                <div class="step-content">
                    <!-- 画像アップロードエリア -->
                    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                        <p>📸 人物画像をアップロードすると自動で処理開始</p>
                        <p>クリックまたはドラッグ&ドロップ</p>
                        <p><small>PNG, JPG, JPEG, GIF (最大16MB)</small></p>
                    </div>
                    
                    <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.gif">

                    <!-- 解析結果表示 -->
                    <div id="step1Results" style="display: none;">
                        <!-- JSONは非表示 -->
                        <div id="featuresResult" style="display: none;"></div>
                        
                        <h4>📝 抽出された特徴</h4>
                        <div id="yamlResult" class="output-section"></div>
                    </div>
                </div>
            </div>

            <!-- Step 2: イラスト生成 -->
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div>
                        <h3 class="step-title">🎨 イラスト生成</h3>
                        <p class="step-description">
                            抽出された特徴と「みん銀スタイル」固定仕様を組み合わせて統一感のあるイラストを生成します
                        </p>
                    </div>
                </div>
                <div class="step-content">

                    <!-- イラスト生成結果 -->
                    <div id="step2Results" style="display: none;">
                        <h4>📝 生成プロンプト</h4>
                        <div id="promptResult" class="output-section"></div>
                        
                        <h4>🖼️ 生成されたイラスト</h4>
                        <div id="generatedImage" class="generated-image"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ローディング表示 -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>処理中...</p>
        </div>
    </div>

    <script>
        // グローバル変数
        let currentFeatures = null;
        let styleGuide = null;

        // みん銀スタイル生成クラス（簡素化版）
        class MinginStyleGuide {
            constructor() {
                // 7つの重要な特徴のみを抽出するスキーマ
                this.extractionSchema = {
                    // 1. 服装の種類と柄
                    clothing: {
                        top: {
                            type: ["Tシャツ", "ブラウス", "ワイシャツ", "スウェット", "パーカ", "プルオーバー", "ブレザー", "カーディガン"],
                            pattern: ["無地", "ストライプ", "格子", "ドット", "ロゴ"]
                        },
                        bottom: {
                            type: ["ジーンズ", "チノパン", "ワイドパンツ", "スカート", "ワンピース"]
                        }
                    },
                    // 2. 髪型とボリューム
                    hair: {
                        style: ["short", "bob", "long", "tied", "curly"],
                        volume: ["flat", "medium", "voluminous"]
                    },
                    // 3. 体型とポーズ
                    silhouette: {
                        body_type: ["slim", "average", "large"],
                        pose: ["standing", "walking", "waving", "holding_item"]
                    },
                    // 4. ヒゲの状態（薄い場合は無し）
                    beard: {
                        style: ["none", "顎先のみ", "口ひげ", "あごひげ", "組み合わせ"]
                    },
                    // 5. メガネの有無
                    glasses: ["none", "round", "square", "thick_frame"],
                    // 6. アクセサリー
                    accessories: {
                        items: ["none", "hat", "bag", "headphones", "watch", "smartphone"]
                    },
                    // 7. 全体的なシルエット
                    overall_silhouette: ["逆三角", "長方形", "砂時計"]
                };

                // みん銀スタイル固定仕様（docs/みん銀スタイル.yamlから）
                this.fixedStyleSpecs = {
                    // 描線
                    line: "ボールペン程度の細さで均一幅",
                    // 塗り
                    fill: "白地＋黒ベタの２値構成",
                    // 視点
                    viewpoint: "必ず真横または3/4ビュー（斜め向き）",
                    // 目
                    eyes: "極小の黒ドット、頭頂から顎の1/3位置",
                    // 鼻
                    nose: "輪郭線のみ、内部線なし",
                    // 眉・口・耳
                    facial_features: "眉・口・耳は完全に描かない",
                    // 顔内部線
                    face_interior: "目と鼻以外は一切の線を描かない",
                    // 首
                    neck: "太く描き、現実の1.5倍程度にデフォルメ",
                    // 肩
                    shoulders: "極端ななで肩（30-45度下向き傾斜）",
                    // 流れ
                    flow: "顔→首→肩→腕を滑らかな曲線で構成"
                };
            }

            generateAnalysisPrompt() {
                return `この人物画像を詳細に分析して、「みん銀スタイル」のイラスト生成に必要な7つの特徴を文章で具体的に描写してください。

【抽出対象の7つの特徴】
1. 服装の種類と柄 - 具体的な服装と色、柄、スタイルを詳しく描写
2. 髪型とボリューム - 長さ、スタイル、質感、ボリューム感を詳しく描写  
3. 体型とポーズ - 体格、姿勢、動作を詳しく描写
4. ヒゲの状態 - ヒゲの有無、濃さ、形状を詳しく描写（薄い場合は「なし」）
5. メガネの有無と特徴 - メガネの形状、色、特徴を詳しく描写
6. アクセサリー - 身に着けている小物類を詳しく描写
7. 全体的なシルエット - 体型の特徴、バランス、印象を詳しく描写

【重要な指示】
- 選択肢に縛られず、見えるままを自然な文章で具体的に描写してください
- 色や質感、印象なども含めて詳しく説明してください
- 曖昧な表現ではなく、具体的で明確な描写をしてください

【JSON出力形式】
以下の形式で、各項目を詳細な文章で回答してください：
{
  "clothing": "服装の具体的な描写（種類、色、柄、スタイルなど）",
  "hair": "髪型の具体的な描写（長さ、スタイル、質感、ボリュームなど）",
  "body_pose": "体型とポーズの具体的な描写（体格、姿勢、動作など）",
  "beard": "ヒゲの具体的な描写（有無、濃さ、形状など）",
  "glasses": "メガネの具体的な描写（有無、形状、色、特徴など）",
  "accessories": "アクセサリーの具体的な描写（種類、特徴、印象など）",
  "silhouette": "全体シルエットの具体的な描写（体型バランス、印象など）"
}

JSONのみを回答してください。`;
            }

            // 解析結果から特徴要約を生成
            summarizeFeatures(analyzedFeatures) {
                const summary = {
                    clothing: analyzedFeatures.clothing || '服装情報が取得できませんでした',
                    hair: analyzedFeatures.hair || '髪型情報が取得できませんでした',
                    body: analyzedFeatures.body_pose || '体型・ポーズ情報が取得できませんでした',
                    beard: analyzedFeatures.beard || 'ヒゲ情報が取得できませんでした',
                    glasses: analyzedFeatures.glasses || 'メガネ情報が取得できませんでした',
                    accessories: analyzedFeatures.accessories || 'アクセサリー情報が取得できませんでした',
                    silhouette: analyzedFeatures.silhouette || 'シルエット情報が取得できませんでした'
                };
                return summary;
            }

            // 人物特徴をテキスト形式で整理
            formatFeatures(features) {
                return `【抽出された特徴】

🧥 服装
${features.clothing}

💇 髪型
${features.hair}

🧍 体型・ポーズ
${features.body}

🧔 ヒゲ
${features.beard}

👓 メガネ
${features.glasses}

💍 アクセサリー
${features.accessories}

👤 全体シルエット
${features.silhouette}`;
            }

            // みん銀スタイル仕様に基づくイラスト生成プロンプト
            generateIllustrationPrompt(analyzedFeatures) {
                const summary = this.summarizeFeatures(analyzedFeatures);
                
                return `Create an illustration following the exact "みん銀スタイル" specification:

【人物の特徴。厳守】
服装: ${summary.clothing}
髪型: ${summary.hair}
体型・ポーズ: ${summary.body}
ヒゲ: ${summary.beard}
メガネ: ${summary.glasses}
アクセサリー: ${summary.accessories}
全体シルエット: ${summary.silhouette}

【みん銀スタイル固定仕様。厳守】
みん銀スタイル:
  目的: >-
    みんなの銀行の広告イラストを、どの人物モデルでも統一された“みん銀らしさ”で
    描き替えられるように、共通する造形ルールを階層的に整理する。
    余計な写実性を削ぎ落とし、線と面の最小構成で世界観を保つことが狙い。

  ─── 全体スタイル ───:
    描線: >-
      すべての輪郭線をボールペン程度の細さで均一幅に統一し、角にわずかな丸みを残して硬さを避ける。
      手描きの揺らぎは抑え、ベジェで滑らかに処理すると世界観が崩れない。
    塗り: >-
      「白地＋黒ベタ」の２値で構成し、影やグラデーションは完全に排除する。
      黒ベタはシルエットを強調したい衣服や髪の塊に限定し、
      黒面積が多い人物と少ない人物を混在させてリズムを作る。
    余白・構図: >-
      背景は潔い空白とし、人物列なら水平、スパイラルなら対角線上に
      大胆なネガティブスペースを残すことで広告的な抜けを確保する。

  ─── 人物設計 ───:
    体型とプロポーション:
      共通ルール: >-
        現実をベースにしつつ脚を長め、胴を短めにデフォルメし、
        歩幅や重心移動を強調して動きを出す。
        肩〜腰のシルエットは「逆三角」「長方形」「砂時計」の３分類を中心に
        適度なバリエーションを持たせる。

    顔:
      視点の前提:
        - 正面向きのキャラクターは存在しない。
        - 必ず「真横」または「3/4ビュー（斜め向き）」で描く。
      頭部輪郭: >-
        ベースは縦長の卵形
        真横向きでも輪郭線を２〜３段階で緩く折り返し、
        “棒状”にならないように注意する。
      髪との取り合い: >-
        髪と顔の境界は一筆書きでつなぎ、
        生え際を波線などで処理してリズムを付ける。
        髪面は黒ベタ、顔面は白地で完全二値化。
      目:
        サイズと形状: >-
          真円の黒ドットに統一し、線だけの円やハイライトは入れない。
          目で見えるギリギリの小ささでボールペンの点を打つイメージ。
        配置: >-
          眼の高さは頭頂から顎までの1/3位置に固定すると
          子どもっぽさを回避して大人の比率に落ち着く。
        奥側の目: >-
          3/4向きでは顔輪郭線より内側に収めず、
          あえて「輪郭線から1〜2px浮かせて空中に描く」。
          独特の平面感を生むため必ず実施。
      鼻:
        表現方法:
          鼻は輪郭線のみで表現し、内部線は一切描かない。
          鼻孔、影、ハイライトなどの詳細は完全に省略する。
          顔の輪郭から自然に突出するシンプルな線として描く。
        配置: >-
          3/4ビューでは顔中央よりわずかに前方（進行方向）へ寄せる。
          真横ビューでは輪郭外に1〜2px張り出し、
          鼻先が顔の最前端になるようにする。
      眉・口・耳: >-
        ３要素とも完全に描かない。
        感情や視線方向は鼻の向き・首の傾き・腕や肩の動きで補う。
      ヒゲ（任意）: >-
        ヒゲが目立つ人物のみ記述。
        線で輪郭を刻まず、顔輪郭と一体化させて面で処理する。
        パターン:
          - 顎先のみ: あご先の小さな三角形状の黒ベタ
          - 口ひげ: 鼻と口の間の横長の黒ベタ
          - あごひげ: 顎から頬にかけての黒ベタ
          - 組み合わせ: 口ひげ＋あごひげなど複数パターンの組み合わせ
      顎・輪郭下部: >-
        首との境目を水平気味の線で区切り、
        顎下に影線や黒ベタを入れない。
        面長強調が必要な男性のみ下顎左右をほんの僅かに張る。
      顔の内部線排除: >-
        目（小さな黒ドット）と鼻（輪郭のみ）以外は、顔の内部に一切の線を描かない。
        ほうれい線、しわ、影、口元の線、頬の線などは完全に排除し、
        清潔で簡潔な白い面で顔を構成する。

    首と肩の構造:
      首: >-
        首は太く描き、頭部との視覚的バランスを取る。
        現実的な首の太さより1.5倍程度太くデフォルメする。
        首の輪郭線は顔の輪郭から滑らかに継続する一本線で描く。
      肩: >-
        肩は極端ななで肩にデフォルメし、現実よりも大幅に下がった角度で描く。
        肩のラインは水平から30-45度程度下向きに傾斜させる。
        肩幅は適度に保ちながら、なで肩の特徴を強調する。
      全体の流れ: >-
        首→肩→腕は一つの滑らかな曲線として構成し、
        角張った接続部分を避けて流動的なシルエットを作る。
        各部位の境界線も自然に繋がるよう配慮する。

    髪型パターン:
      共通指針: >-
        髪を“面”で捉え外周を一本線で囲む。
        内側に線は描かず、黒のベタ塗りもしくは白抜き。質感よりシルエットを優先する。
        小さなハネは描かず、緩いカーブからなる塊として表現
      バリエーション:
        - パーマ感のある短いカールを頭頂部に集め、耳まわりをスッキリ描く形。
        - 首元で跳ねるウェーブボブ。外輪は不規則なジグザグラインで動きを演出。
        - 肩を超えるロングウェーブは面積を確保し“く”字連続のフリルラインで外周を走らせる。
        - 後頭部に小さな団子を作る一束結び。髪留めは丸一点の黒で示す。
        - キャップやヘッドホンで前髪を隠す場合は頭頂部の形を単純な半円で処理。

    服装の種類:
      トップス:
        Tシャツ: >-
          白抜き線画で描き、シンプルな輪郭線のみで構成する。
          胸元にワンポイントロゴや文字を黒ベタで配置すると画面にリズムが生まれる。
        ブラウス: >-
          襟や袖口は線のみで表現し、ボタンは小さな点で示す。
          フリルやレースなどの装飾は省略し、基本的な輪郭線に留める。
        ワイシャツ: >-
          襟と前立て（ボタン部分）を明確に線で示す。
          ボタンは等間隔の点で表現し、袖口にカフスの線を追加する。
          ポケットがある場合は線のみで輪郭を描く。
        スウェット・パーカ: >-
          身頃を大胆に黒ベタで塗り、袖口や裾のリブだけを白抜き線で示す。
          パーカの場合はフードの輪郭線を追加する。
        プルオーバー: >-
          ニットの質感は表現せず、シンプルな黒ベタまたは白抜きで処理する。
          襟元（クルーネックやVネック）の形状のみを線で示す。
        ブレザー・カーディガン: >-
          ボタンを等間隔の点で表現し、縫い目やステッチは描かない。
      ボトムス:
        ジーンズ: >-
          基本的な輪郭線のみで描き、ポケットのステッチや膝の補強パーツは省略する。
          ロールアップの場合は裾の折り返しを二重線で示す。
        チノパン: >-
          ジーンズより滑らかな輪郭線で描き、センタープレスがある場合は
          一本の縦線で表現するが点線にはしない。
        ワイドパンツ: >-
          脇線と裾線の４本のみで面積を確保し、
          ゆったりとしたシルエットを強調する。
        スカート: >-
          フレア、タイト、プリーツなど形状に応じてシンプルな輪郭線で表現する。
          プリーツの場合は代表的な折り目数本のみを描く。
        ワンピース: >-
          肩から裾まで一筆書きで取り、
          胴体中央に１本だけシェイプラインを落として立体感を演出する。

    服装の柄・装飾:
      基本原則: >-
        柄は線による表現のみとし、黒ベタ面の上に柄を重ねない。
        線の太さは人物輪郭より細くして主従関係を保つ。
      柄の種類:
        無地: >-
          白抜きまたは黒ベタの単色で処理し、最もシンプルな表現とする。
        ストライプ: >-
          等間隔の平行線で表現し、縦縞・横縞・斜め縞に対応する。
          線の間隔は服の面積に応じて調整する。
        格子・チェック: >-
          縦横の線を組み合わせた格子パターンで表現する。
          複雑なタータンチェックは避け、シンプルな格子に留める。
        ドット: >-
          小さな円の規則的な配置で表現し、大きさは統一する。
          密度は服の面積とバランスを取る。
        ロゴ・文字: >-
          胸部や袖に配置し、黒ベタの塊として処理する。
          文字の詳細は読めなくても良く、形状のみを重視する。

    アクセサリー類:
      指針: >-
        「お金を使う生活シーン」を暗示する小物を
        一人につき１〜２点持たせる。
      具体例:
        - >-
          トートや紙袋は白面積を大きく取り、ロゴを黒ベタで載せる。
        - >-
          ヘッドホンはイヤーカップを黒、ヘッドバンドを白抜きの輪郭で対比させる。
        - >-
          テイクアウトコーヒーはカップを正円＋円柱で構成し、
          ストローやフタの細線で動きを追加する。
        - >-
          PC・タブレットは角丸長方形のみで完結させ、反射ハイライトは描かない。

    ポーズ & 動線:
      共通テンポ: >-
        群像を描く場合は「全員が同じ方向へ歩く」または
        「中心から渦状に広がる」等の大きなベクトルを共有し、
        画面全体の視線誘導を行う。
      個別ポーズ:
        - >-
          歩行は前脚の踵着地、後脚のつま先立ちで誇張し、
          両腕を非対称に振ることで自然なダイナミズムを出す。
        - >-
          頭より上で軽く手を振る“ハロー”ジェスチャーは、
          指を三角形状の束で簡略化し一筆書きで収める。
        - >-
          自転車やスケボーなど乗り物を使う場合でも
          車輪やデッキは輪郭線のみで、黒ベタは乗り手の衣服に集中させる。

  ─── 実装チェックリスト ───:
    - 目は真円ドットで頭頂〜顎の1/3高さに配置されているか。
    - 3/4ビューの奥目が輪郭線から1〜2px浮いているか。
    - 眉・口・耳が一切描かれていないか最終確認する。
    - 鼻以外の顔内部線が存在しないか（ほうれい線、しわ、口元の線、影等も含む）。
    - 首が太く描かれ、頭部とのバランスが取れているか。
    - 肩が極端ななで肩にデフォルメされているか。
    - 顔→首→肩→腕の流れが滑らかな曲線で繋がっているか。
    - 輪郭線の太さは人物全体で統一し、髪と顔で線幅差を付けない。
    - 黒ベタと白抜きの面積比がおおむね３：７を保っているか。
    - 柄物は線による柄のみで、黒ベタ面の上に柄を重ねていないか。
    - 前景と背景が接触するときは0.5px程度の白隙間を残して物体同士を切り離す。
    - 影線・質感表現を加えたくなっても“引き算の美学”を徹底しているか。

Create a clean, minimalist line art illustration in monochrome that perfectly embodies the みん銀 aesthetic.`;
            }

            getDefaultFeatures() {
                return {
                    clothing: "カジュアルな白いTシャツに濃紺のジーンズを着用。シンプルで清潔感のある装い。",
                    hair: "ショートからミディアムヘア。自然なストレートで適度なボリューム。",
                    body_pose: "リラックスした立ち姿。平均的な体型で真っ直ぐ立っている姿勢。",
                    beard: "ヒゲは生えておらず、清潔に剃られている。",
                    glasses: "メガネは着用していない。",
                    accessories: "特に目立つアクセサリーは身に着けていない。",
                    silhouette: "バランスの取れた標準的な体型。肩幅と腰幅のバランスが良い長方形型のシルエット。"
                };
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            styleGuide = new MinginStyleGuide();
            setupEventListeners();
        });

        // イベントリスナー設定
        function setupEventListeners() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.querySelector('.upload-area');
            const apiKeyInput = document.getElementById('apiKeyInput');

            // API Key入力監視
            apiKeyInput.addEventListener('input', function() {
                updateButtonStates();
            });

            // ファイル選択
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    handleFileSelect(e.target.files[0]);
                }
            });

            // ドラッグ&ドロップ
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files[0]);
                }
            });
        }

        // ファイル選択処理
        function handleFileSelect(file) {
            if (!isValidFile(file)) {
                showAlert('無効なファイル形式です。PNG, JPG, JPEG, GIF のみ対応しています。', 'error');
                return;
            }

            if (file.size > 16 * 1024 * 1024) {
                showAlert('ファイルサイズが大きすぎます（最大16MB）', 'error');
                return;
            }

            displayFilePreview(file);
            updateButtonStates();
            
            // 自動で特徴抽出とイラスト生成を実行
            autoProcessImage();
        }

        // ファイル形式チェック
        function isValidFile(file) {
            const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
            return allowedTypes.includes(file.type);
        }

        // ファイルプレビュー表示
        function displayFilePreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const existingPreview = document.querySelector('.preview-image');
                if (existingPreview) {
                    existingPreview.remove();
                }
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'preview-image';
                document.querySelector('.upload-area').appendChild(img);
                
                document.querySelector('.upload-area p').innerHTML = `📸 選択された画像: ${file.name}`;
            };
            reader.readAsDataURL(file);
        }

        // ステップ状態管理
        function updateStepState(stepNumber, state) {
            const step = document.getElementById(`step${stepNumber}`);
            step.classList.remove('active', 'completed');
            
            if (state === 'active') {
                step.classList.add('active');
            } else if (state === 'completed') {
                step.classList.add('completed');
            }
        }

        // ボタン状態更新
        function updateButtonStates() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const fileSelected = document.getElementById('fileInput').files.length > 0;

            // ステップ状態更新
            if (apiKey && fileSelected) {
                updateStepState(1, 'active');
            }
            
            if (currentFeatures) {
                updateStepState(1, 'completed');
                updateStepState(2, 'active');
            }
        }

        // アラート表示
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.api-key-section'));
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // ローディング表示制御
        function setLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // 自動処理実行
        async function autoProcessImage() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKey) {
                showAlert('OpenAI API Keyを入力してから画像をアップロードしてください', 'error');
                return;
            }
            
            try {
                // Step1: 特徴抽出を自動実行
                await analyzeImage();
                
                // Step2: イラスト生成を自動実行
                await generateIllustration();
                
            } catch (error) {
                console.error('Auto process error:', error);
                showAlert(`自動処理エラー: ${error.message}`, 'error');
            }
        }

        // Base64変換
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = error => reject(error);
            });
        }

        // 画像解析
        async function analyzeImage() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const fileInput = document.getElementById('fileInput');
            
            if (!apiKey) {
                showAlert('OpenAI API Keyを入力してください', 'error');
                return;
            }

            if (!fileInput.files.length) {
                showAlert('画像ファイルを選択してください', 'error');
                return;
            }

            const file = fileInput.files[0];
            
            try {
                setLoading(true);

                const base64Image = await fileToBase64(file);
                console.log('🔍 Base64 Image Length:', base64Image.length);
                
                const prompt = styleGuide.generateAnalysisPrompt();
                console.log('🔍 Analysis Prompt:', prompt);

                const requestBody = JSON.stringify({
                    model: "gpt-4o",
                    messages: [{
                        role: "user",
                        content: [
                            { type: "text", text: prompt },
                            { 
                                type: "image_url", 
                                image_url: { 
                                    url: `data:image/jpeg;base64,${base64Image}` 
                                }
                            }
                        ]
                    }],
                    max_tokens: 1000
                });

                console.log('🔍 Request Body Structure:', {
                    model: "gpt-4o",
                    messages: "Array with text and image",
                    max_tokens: 1000
                });

                const encoder = new TextEncoder();
                const encodedBody = encoder.encode(requestBody);

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: encodedBody
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                console.log('🔍 Full API Response:', data);
                
                const content = data.choices[0].message.content;
                console.log('🔍 GPT-4o Response Content:', content);

                // JSONを抽出
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    console.error('❌ JSON not found in response:', content);
                    throw new Error('有効なJSONレスポンスが見つかりませんでした');
                }

                console.log('🔍 Extracted JSON String:', jsonMatch[0]);
                currentFeatures = JSON.parse(jsonMatch[0]);
                console.log('✅ Parsed Features:', currentFeatures);
                
                // 結果表示
                document.getElementById('featuresResult').textContent = JSON.stringify(currentFeatures, null, 2);
                
                // 特徴要約を生成・表示
                const summary = styleGuide.summarizeFeatures(currentFeatures);
                const formattedFeatures = styleGuide.formatFeatures(summary);
                document.getElementById('yamlResult').textContent = formattedFeatures;
                
                // Step1の結果を表示
                document.getElementById('step1Results').style.display = 'block';
                
                showAlert('人物の特徴抽出が完了しました', 'success');
                updateButtonStates();

            } catch (error) {
                console.error('❌ Analysis error:', error);
                console.log('⚠️ Using default features due to error');
                showAlert(`特徴抽出エラー: ${error.message}`, 'error');
                
                // デフォルト特徴を使用
                currentFeatures = styleGuide.getDefaultFeatures();
                console.log('🔄 Default Features:', currentFeatures);
                document.getElementById('featuresResult').textContent = JSON.stringify(currentFeatures, null, 2);
                
                // デフォルト特徴で要約を生成・表示
                const summary = styleGuide.summarizeFeatures(currentFeatures);
                const formattedFeatures = styleGuide.formatFeatures(summary);
                document.getElementById('yamlResult').textContent = formattedFeatures;
                
                // Step1の結果を表示
                document.getElementById('step1Results').style.display = 'block';
                showAlert('デフォルト設定で続行します', 'warning');
                updateButtonStates();
                
            } finally {
                setLoading(false);
            }
        }

        // イラスト生成
        async function generateIllustration() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKey) {
                showAlert('OpenAI API Keyを入力してください', 'error');
                return;
            }

            if (!currentFeatures) {
                showAlert('まず人物の特徴抽出を実行してください', 'error');
                return;
            }

            try {
                setLoading(true);

                const prompt = styleGuide.generateIllustrationPrompt(currentFeatures);
                document.getElementById('promptResult').textContent = prompt;
                
                const selectedQuality = document.getElementById('qualitySelect').value;

                const requestBody = JSON.stringify({
                    model: "gpt-image-1",
                    prompt: prompt,
                    size: "1024x1024",
                    quality: selectedQuality,
                    output_format: "png",
                    n: 1
                });

                const encoder = new TextEncoder();
                const encodedBody = encoder.encode(requestBody);

                const response = await fetch('https://api.openai.com/v1/images/generations', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json; charset=utf-8'
                    },
                    body: encodedBody
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API Error: ${errorData.error?.message || response.statusText}`);
                }

                const data = await response.json();
                console.log('Full API response:', data);
                
                if (!data.data || data.data.length === 0) {
                    console.error('No image data in response:', data);
                    throw new Error('画像データが生成されませんでした');
                }

                const imageData = data.data[0];
                console.log('Image data object:', imageData);
                console.log('Available properties:', Object.keys(imageData));
                
                let imageUrl;

                if (imageData.url) {
                    console.log('Using URL:', imageData.url);
                    imageUrl = imageData.url;
                } else if (imageData.b64_json) {
                    console.log('Using base64 data');
                    imageUrl = `data:image/png;base64,${imageData.b64_json}`;
                } else if (imageData.data) {
                    console.log('Using embedded data field');
                    imageUrl = `data:image/png;base64,${imageData.data}`;
                } else {
                    console.error('No usable image data found. Available keys:', Object.keys(imageData));
                    throw new Error('画像URLまたはBase64データが見つかりませんでした');
                }

                console.log('Final image URL:', imageUrl.substring(0, 100) + '...');

                // 画像表示
                const imageContainer = document.getElementById('generatedImage');
                imageContainer.innerHTML = `
                    <img src="${imageUrl}" alt="Generated Illustration" 
                         onload="console.log('Image loaded successfully')" 
                         onerror="console.error('Image load failed:', this.src.substring(0, 100));">
                    <br><br>
                    <a href="${imageUrl}" target="_blank" class="btn">🔗 フルサイズで表示</a>
                `;

                // Step2の結果を表示
                document.getElementById('step2Results').style.display = 'block';
                
                // Step2を完了状態に
                updateStepState(2, 'completed');

                showAlert('イラスト生成が完了しました', 'success');

            } catch (error) {
                console.error('Generation error:', error);
                showAlert(`生成エラー: ${error.message}`, 'error');
                
            } finally {
                setLoading(false);
            }
        }
    </script>
</body>
</html>